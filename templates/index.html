<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>2025 å…¨å›½å¤©æ°”è§†ç•Œ</title>
    <script src="https://registry.npmmirror.com/echarts/5.4.3/files/dist/echarts.min.js"></script>
    <script src="https://registry.npmmirror.com/echarts/5.4.3/files/map/js/china.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* ä¾§è¾¹æ å’Œç»ç’ƒç‰¹æ•ˆ */
        :root { --sidebar-w: 320px; --glass-sidebar: rgba(255, 255, 255, 0.75); --glass-blur: 40px; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif; overflow-x: hidden; background: #000; }
        * { box-sizing: border-box; }

        .sidebar { position: fixed; top: 0; left: 0; width: var(--sidebar-w); height: 100vh; background: var(--glass-sidebar); backdrop-filter: blur(var(--glass-blur)); border-right: 1px solid rgba(255,255,255,0.3); z-index: 100; display: flex; flex-direction: column; }
        
        .user-info { padding: 40px 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.2); }
        .avatar { width: 70px; height: 70px; background: #fff; border-radius: 50%; margin: 0 auto 15px; line-height: 70px; font-size: 30px; color: #0071e3; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display:flex; align-items:center; justify-content:center;}
        .username { font-size: 22px; font-weight: 700; color: #1d1d1f; }
        
        .links { margin-top: 15px; display: flex; justify-content: center; gap: 10px; }
        /* ğŸ”¥ å…³é”®ä¿®å¤ï¼šç¡®ä¿é“¾æ¥å¯ç‚¹å‡» */
        .links a { font-size: 14px; color: #0071e3; text-decoration: none; cursor: pointer; transition: 0.2s; position: relative; z-index: 101; }
        .links a:hover { text-shadow: 0 0 5px rgba(0,113,227,0.3); text-decoration: underline; }
        
        .search-box { padding: 20px; }
        .search-input { width: 100%; padding: 14px 18px; border-radius: 12px; border: none; background: rgba(255,255,255,0.5); outline: none; font-size: 14px; }
        .city-list { flex: 1; overflow-y: auto; padding: 0 15px 20px; }
        .city-list::-webkit-scrollbar { width: 0; }
        .city-item { padding: 12px 15px; margin-bottom: 8px; border-radius: 10px; cursor: pointer; display: flex; justify-content: space-between; background: rgba(255,255,255,0.3); transition: 0.2s; }
        .city-item:hover { background: rgba(255,255,255,0.8); }
        .list-header { font-size: 12px; color: #666; font-weight: bold; margin: 10px 5px; opacity: 0.8; }
        .province-tag { font-size: 11px; color: #666; background: rgba(255,255,255,0.5); padding: 2px 8px; border-radius: 6px; }

        .main-viewport { margin-left: var(--sidebar-w); }
        .section { min-height: 100vh; width: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background-attachment: fixed; background-size: cover; padding: 60px 0; }
        .section::before { content: ''; position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.15); z-index: 0; }
        #spring { background-image: url('/static/picture/1.png'); }
        #summer { background-image: url('/static/picture/2.png'); }
        #autumn { background-image: url('/static/picture/3.png'); }
        #winter { background-image: url('/static/picture/4.png'); }

        .section-title { position: relative; z-index: 2; font-size: 42px; font-weight: 800; color: #fff; text-shadow: 0 0 20px rgba(255,255,255,0.4); margin-bottom: 30px; }
        .map-container-glass { position: relative; z-index: 2; width: 90%; max-width: 1200px; height: 75vh; }
        #china_map { width: 100%; height: 100%; }

        /* å¼¹çª—æ ·å¼ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(10px); z-index: 9999; justify-content: center; align-items: center; }
        
        .pwd-modal-content { background: #fff; padding: 30px; border-radius: 20px; width: 350px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); position: relative; }
        .pwd-input { width: 100%; padding: 12px; margin: 15px 0; border: 1px solid #ddd; border-radius: 8px; background: #f5f5f7; font-size: 14px; outline:none; }
        .pwd-btn { width: 100%; padding: 12px; background: #0071e3; color: white; border: none; border-radius: 8px; cursor: pointer; }
        .pwd-btn:hover { background: #0077ed; }

        .chart-modal-content { background: rgba(255,255,255,0.95); width: 900px; min-height: 80vh; border-radius: 30px; padding: 30px; position: relative; display: flex; flex-direction: column; overflow-y: auto; max-height: 90vh; }
        #lineChart { width: 100%; height: 400px; margin-top: 20px; }
        .glass-table { width: 100%; border-collapse: collapse; background: rgba(255,255,255,0.5); border-radius: 10px; overflow: hidden; margin-top: 20px; }
        .glass-table th { padding: 12px; text-align: left; background: rgba(0,113,227,0.1); color: #0071e3; }
        .glass-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; font-size: 14px; }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 28px; cursor: pointer; color: #999; }
        .close-btn:hover { color: #333; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="user-info">
            <div class="avatar"><i class="fas fa-user"></i></div>
            <div class="username">{{ username }}</div>
            <div class="links">
                <a href="javascript:void(0)" onclick="openPwdModal()"><i class="fas fa-key"></i> ä¿®æ”¹å¯†ç </a>
                <span style="color:#ccc">|</span>
                <a href="/logout" style="color:#ff3b30">é€€å‡º</a>
            </div>
        </div>
        <div class="search-box">
            <input type="text" class="search-input" id="searchInput" placeholder="ğŸ” æœçƒ­é—¨åŸå¸‚...">
        </div>
        <div class="city-list" id="cityList"></div>
    </div>

    <div class="main-viewport">
        <section id="spring" class="section">
            <h1 class="section-title"><i class="fas fa-globe-asia"></i> 2025 å…¨å±€æ°”å€™ç›‘æµ‹</h1>
            <div class="map-container-glass"><div id="china_map"></div></div>
            <div style="color:white; margin-top:20px; opacity:0.8;">â†“ å‘ä¸‹æ»šåŠ¨æµè§ˆæ›´å¤š â†“</div>
        </section>
        <section id="summer" class="section"><h1 class="section-title"><i class="fas fa-fire"></i> å¤å­£é«˜æ¸©åˆ†æ</h1></section>
        <section id="autumn" class="section"><h1 class="section-title"><i class="fas fa-leaf"></i> ç§‹å­£æ¸©å·®ç›‘æµ‹</h1></section>
        <section id="winter" class="section"><h1 class="section-title"><i class="fas fa-snowflake"></i> å†¬å­£æå¯’é¢„è­¦</h1></section>
    </div>

    <div class="modal" id="pwdModal">
        <div class="pwd-modal-content">
            <span class="close-btn" onclick="document.getElementById('pwdModal').style.display='none'">Ã—</span>
            <h3 style="margin-top:0;">ä¿®æ”¹å¯†ç </h3>
            <p style="color:#666; font-size:12px;">æ–°å¯†ç ç›´æ¥ç”Ÿæ•ˆ (æ— éœ€å®¡æ ¸)</p>
            <input type="password" id="newPwd" class="pwd-input" placeholder="è¾“å…¥æ–°å¯†ç ">
            <button class="pwd-btn" onclick="submitPwdChange()">ç«‹å³ä¿®æ”¹</button>
        </div>
    </div>

    <div class="modal" id="chartModal">
        <div class="chart-modal-content">
            <span class="close-btn" onclick="document.getElementById('chartModal').style.display='none'">Ã—</span>
            <h2 id="modalTitle">è¯¦æƒ…</h2>
            <div id="lineChart"></div>
            <div style="font-weight:bold; margin-top:20px; color:#333;">ğŸ“… æ•°æ®æ˜ç»†</div>
            <table class="glass-table">
                <thead><tr><th>æœˆä»½</th><th>å‡é«˜</th><th>å‡ä½</th><th>æé«˜</th><th>æä½</th></tr></thead>
                <tbody id="weatherTableBody"></tbody>
            </table>
        </div>
    </div>

<script>
    // ğŸ”‘ ä¿®æ”¹å¯†ç 
    function openPwdModal() { document.getElementById('pwdModal').style.display='flex'; }
    function submitPwdChange() {
        const pwd = document.getElementById('newPwd').value;
        if(!pwd) { alert("å¯†ç ä¸èƒ½ä¸ºç©º"); return; }
        fetch('/api/request_password_change', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({new_password: pwd})
        }).then(res=>res.json()).then(res=>{
            alert(res.msg);
            if(res.code===200) { document.getElementById('pwdModal').style.display='none'; document.getElementById('newPwd').value=''; }
        });
    }

    // ğŸŒ åŸå¸‚åˆ—è¡¨ (å¸¦å®¹é”™)
    function loadCities(q='') {
        const listEl = document.getElementById('cityList');
        if(q==='') listEl.innerHTML = '<div style="text-align:center;padding:20px;color:#999;">æ­£åœ¨åŠ è½½...</div>';
        
        fetch(`/api/cities?q=${q}`).then(res=>res.json()).then(res=>{
            if(res.code===200 && res.data.length>0){
                let html = q==='' ? '<div class="list-header">ğŸ”¥ çƒ­é—¨æ¨è</div>' : '<div class="list-header">ğŸ” æœç´¢ç»“æœ</div>';
                html += res.data.map(c => `<div class="city-item" onclick="showWeather('${c.pinyin}','${c.name}')"><b>${c.name}</b><span class="province-tag">${c.province}</span></div>`).join('');
                listEl.innerHTML = html;
            } else { listEl.innerHTML = '<div style="text-align:center;padding:20px;color:#999;">æš‚æ— æ•°æ®</div>'; }
        }).catch(()=>{ listEl.innerHTML = '<div style="text-align:center;padding:20px;color:red;">åŠ è½½å¤±è´¥</div>'; });
    }
    document.getElementById('searchInput').addEventListener('input', e=>setTimeout(()=>loadCities(e.target.value),300));
    loadCities();

    // ğŸ—ºï¸ åœ°å›¾ & å›¾è¡¨
    const mapChart = echarts.init(document.getElementById('china_map'));
    fetch('/api/map_data').then(res=>res.json()).then(res=>{
        mapChart.setOption({
            tooltip: {formatter:p=>`<b>${p.name}</b>: ${p.value}Â°C`},
            visualMap: {min:-10,max:25,left:20,bottom:20,inRange:{color:['#313695','#fdae61','#a50026']},textStyle:{color:'#fff'}},
            series: [{type:'map',map:'china',zoom:1.2,itemStyle:{areaColor:'rgba(255,255,255,0.15)',borderColor:'#fff'},emphasis:{itemStyle:{areaColor:'#0071e3'}},data:res.data}]
        });
    });

    const lineChart = echarts.init(document.getElementById('lineChart'));
    function showWeather(pinyin, name) {
        document.getElementById('chartModal').style.display='flex';
        document.getElementById('modalTitle').innerText = name + " 2025æ°”å€™";
        lineChart.resize(); lineChart.showLoading();
        fetch(`/api/weather?city=${pinyin}`).then(res=>res.json()).then(res=>{
            lineChart.hideLoading();
            const d = res.data;
            lineChart.setOption({
                tooltip:{trigger:'axis'}, xAxis:{type:'category',data:d.dates}, yAxis:{type:'value'},
                series:[{name:'é«˜æ¸©',type:'line',data:d.avg_max,smooth:true,itemStyle:{color:'red'}},{name:'ä½æ¸©',type:'line',data:d.avg_min,smooth:true,itemStyle:{color:'blue'}}]
            });
            document.getElementById('weatherTableBody').innerHTML = d.table_data.map(r=>`<tr><td>${r.date}</td><td>${r.avg_max}</td><td>${r.avg_min}</td><td>${r.ext_max}</td><td>${r.ext_min}</td></tr>`).join('');
        });
    }
    window.addEventListener('resize', ()=>{mapChart.resize();lineChart.resize()});
</script>
</body>
</html>